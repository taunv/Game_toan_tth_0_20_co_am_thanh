<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ch∆°i v√† H·ªçc To√°n TTH (0‚Äì20)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    font-family: Arial, sans-serif;
    background:#f0f8ff;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
}
#game-container{
    background:#fff;
    border-radius:20px;
    padding:30px;
    max-width:520px;
    width:95%;
    box-shadow:0 10px 20px rgba(0,0,0,.15);
    text-align:center;
}
h1{color:#ff69b4;margin-top:0}
#controls-top{
    display:flex;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
}
select,button{
    font-size:16px;
    padding:8px 12px;
    border-radius:10px;
    border:none;
}
button{cursor:pointer}
#startButton{
    background:#22c55e;
    color:#fff;
    font-size:20px;
    padding:12px 24px;
}
#timer-display{
    font-size:32px;
    color:#ff4500;
    font-weight:bold;
}
#question-area{
    background:#ffe0b2;
    padding:20px;
    border-radius:15px;
    margin:15px 0;
}
#current-question{
    font-size:36px;
    font-weight:bold;
    margin:0;
}
.answer-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:15px;
}
.answer-btn{
    font-size:26px;
    padding:18px;
    border-radius:15px;
    background:#00bfff;
    color:#fff;
}
.answer-btn:hover{background:#0099cc}
#feedback-area{
    min-height:50px;
    font-size:20px;
    font-weight:bold;
    margin-top:10px;
}
#progress-display{color:#666;margin-top:10px}
.summary-title{
    font-size:26px;
    color:#ff69b4;
    font-weight:bold;
}
</style>
</head>

<body>
<div id="game-container">
<h1>Ch∆°i v√† H·ªçc To√°n TTH (0‚Äì20)</h1>

<div id="controls-top">
    <select id="levelSelect">
        <option value="easy">D·ªÖ</option>
        <option value="medium" selected>Trung b√¨nh</option>
        <option value="hard">Kh√≥</option>
    </select>
    <button onclick="toggleSound()" id="soundBtn">üîä √Çm thanh: B·∫¨T</button>
</div>

<button id="startButton" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>

<div id="game-area" style="display:none">
    <div id="timer-display">‚è≥ 20s</div>

    <div id="question-area">
        <p id="current-question"></p>
    </div>

    <div class="answer-grid" id="answer-grid"></div>

    <div id="feedback-area"></div>
    <div id="progress-display"></div>
</div>
</div>

<script>
/* ===== C·∫§U H√åNH ===== */
const GIOI_HAN = 20;
const SO_BAI = 5;
const THOI_GIAN = 20;

/* ===== BI·∫æN ===== */
let bai=0, dapAn=0, timer, timeLeft;
let score={correct:0,incorrect:0};
let soundOn=true;

/* ===== √ÇM THANH & GI·ªåNG ƒê·ªåC ===== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function beep(type){
    if(!soundOn) return;
    let o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.value=type==="correct"?880:220;
    g.gain.value=.25;
    o.start(); o.stop(audioCtx.currentTime+.3);
}
function speak(text){
    if(!soundOn) return;
    speechSynthesis.cancel();
    let u=new SpeechSynthesisUtterance(text);
    u.lang="vi-VN";
    speechSynthesis.speak(u);
}
function toggleSound(){
    soundOn=!soundOn;
    document.getElementById("soundBtn").innerText=
        soundOn?"üîä √Çm thanh: B·∫¨T":"üîá √Çm thanh: T·∫ÆT";
}

/* ===== S·ªê ‚Üí CH·ªÆ TI·∫æNG VI·ªÜT (0‚Äì20) ===== */
const soChu = [
    "kh√¥ng","m·ªôt","hai","ba","b·ªën","nƒÉm","s√°u","b·∫£y","t√°m","ch√≠n",
    "m∆∞·ªùi","m∆∞·ªùi m·ªôt","m∆∞·ªùi hai","m∆∞·ªùi ba","m∆∞·ªùi b·ªën",
    "m∆∞·ªùi lƒÉm","m∆∞·ªùi s√°u","m∆∞·ªùi b·∫£y","m∆∞·ªùi t√°m","m∆∞·ªùi ch√≠n","hai m∆∞∆°i"
];
function docSo(n){
    return soChu[n] ?? n.toString();
}

/* ===== ƒê·ªåC PH√âP TO√ÅN ===== */
function docPhepToan(text){
    let s = text
        .replace(/\d+/g, m => docSo(parseInt(m)))
        .replace(/\+/g," c·ªông ")
        .replace(/\-/g," tr·ª´ ")
        .replace("="," b·∫±ng m·∫•y");
    speak(s);
}

/* ===== T·∫†O C√ÇU H·ªéI ===== */
function taoCauHoi(){
    let level=document.getElementById("levelSelect").value;
    let steps=level==="easy"?1:level==="medium"?2:3;
    let kq=Math.floor(Math.random()*GIOI_HAN);
    let text=kq.toString();

    for(let i=0;i<steps;i++){
        let op=Math.random()<.5?"+":"-";
        let so=Math.floor(Math.random()*10)+1;
        if(op==="+" && kq+so<=GIOI_HAN) kq+=so;
        else if(op==="-" && kq-so>=0) kq-=so;
        else{op="+";so=Math.min(so,GIOI_HAN-kq);kq+=so;}
        text+=` ${op} ${so}`;
    }
    return{question:text+" = ?",answer:kq};
}
function taoDapAn(d){
    let s=new Set([d]);
    while(s.size<4){
        let x=d+Math.floor(Math.random()*11)-5;
        if(x>=0&&x<=GIOI_HAN)s.add(x);
    }
    return[...s].sort(()=>Math.random()-.5);
}

/* ===== TIMER ===== */
function startTimer(){
    clearInterval(timer);
    timeLeft=THOI_GIAN;
    updateTimer();
    timer=setInterval(()=>{
        timeLeft--;
        updateTimer();
        if(timeLeft<=0){
            clearInterval(timer);
            beep("wrong");
            speak("H·∫øt gi·ªù");
            showAnswer();
        }
    },1000);
}
function updateTimer(){
    document.getElementById("timer-display").innerText=`‚è≥ ${timeLeft}s`;
}

/* ===== GAME ===== */
function startGame(){
    bai=0; score={correct:0,incorrect:0};
    document.getElementById("startButton").style.display="none";
    document.getElementById("game-area").style.display="block";
    next();
}
function next(){
    if(bai>=SO_BAI) return endGame();
    bai++;
    document.getElementById("feedback-area").innerText="";
    document.getElementById("progress-display").innerText=`B√†i ${bai}/${SO_BAI}`;

    let q=taoCauHoi();
    dapAn=q.answer;
    document.getElementById("current-question").innerText=q.question;
    docPhepToan(q.question);

    let g=document.getElementById("answer-grid");
    g.innerHTML="";
    taoDapAn(dapAn).forEach(v=>{
        let b=document.createElement("button");
        b.className="answer-btn";
        b.innerText=v;
        b.onclick=()=>check(v);
        g.appendChild(b);
    });
    startTimer();
}
function check(v){
    clearInterval(timer);
    if(v===dapAn){
        score.correct++;
        beep("correct"); speak("ƒê√∫ng r·ªìi");
        document.getElementById("feedback-area").innerText="üéâ ƒê√öNG R·ªíI!";
        setTimeout(next,1500);
    }else{
        score.incorrect++;
        beep("wrong"); speak("Sai r·ªìi");
        showAnswer();
    }
}
function showAnswer(){
    document.getElementById("feedback-area").innerText=
        `‚ùå Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√† ${dapAn}`;
    setTimeout(next,2000);
}
function endGame(){
    document.getElementById("game-area").innerHTML=`
        <p class="summary-title">ü•≥ HO√ÄN TH√ÄNH!</p>
        <p>‚úÖ ƒê√öNG: ${score.correct}</p>
        <p>‚ùå SAI: ${score.incorrect}</p>`;
    let b=document.getElementById("startButton");
    b.innerText="CH∆†I L·∫†I";
    b.style.display="inline-block";
    b.onclick=()=>location.reload();
}
</script>
</body>
</html>